<script>
    // 1. STATE & DATA
    let currentLang = localStorage.getItem('alby_lang') || 'en';

    const translations = {
        en: {
            langBtn: "Espa침ol",
            subHeader: "Official 2026 Resource Hub for Albion, NY",
            chatTitle: "Talk to Alby",
            placeholder: "How can I help you, neighbor?",
            sendBtn: "Send Message",
            emergencyTitle: "Emergency Services",
            emergencyDesc: "Immediate dispatch for fires, medical, or police.",
            call911: "CALL 911",
            foodTitle: "Albion Food Pantry",
            foodDesc: "411 E. State St. Mon-Fri 9am-4pm.",
            foodLink: "Visit Website",
            heapTitle: "HEAP Assistance",
            heapDesc: "Heating help: ID & Bills required.",
            heapLink: "Apply Online",
            openNow: "Open now",
            reportLink: "Link not working?",
            closedNow: "Closed now 췅 Opens Mon-Fri 9am",
            verifiedNote: "Verified by community",
            calmTitle: "You don't have to go through this alone.",
            calmText: "If things feel overwhelming, there are people who will listen without judgment.",
            calmOptions: [
                '游 <a href="tel:988">988 Crisis Lifeline (24/7)</a>',
                '游눫 <a href="https://988lifeline.org/chat/" target="_blank">988 Chat Online</a>'
            ],
            received: "Thanks, neighbor! I've logged your request.",
            emergencyReply: "游뚿 <b>CALL 911 IMMEDIATELY.</b>"
        },
        es: {
            langBtn: "English",
            subHeader: "Centro Oficial de Recursos 2026 para Albion, NY",
            chatTitle: "Habla con Alby",
            placeholder: "쮺칩mo puedo ayudarte?",
            sendBtn: "Enviar mensaje",
            emergencyTitle: "Servicios de Emergencia",
            emergencyDesc: "Despacho inmediato para emergencias.",
            call911: "LLAMAR AL 911",
            foodTitle: "Despensa de Alimentos",
            foodDesc: "411 E. State St. Lun-Vie 9am-4pm.",
            foodLink: "Visitar Sitio",
            heapTitle: "Asistencia HEAP",
            heapDesc: "Ayuda de calefacci칩n: ID y facturas.",
            heapLink: "Aplicar en l칤nea",
            openNow: "Abierto ahora",
            reportLink: "쮼nlace roto?",
            closedNow: "Cerrado ahora 췅 Abre Lun-Vie 9am",
            verifiedNote: "Verificado por vecinos",
            calmTitle: "No est치s solo/a.",
            calmText: "Si te sientes abrumado/a, hay personas que escuchan sin juzgar.",
            calmOptions: [
                '游 <a href="tel:988">L칤nea 988 (24/7)</a>',
                '游눫 <a href="https://988lifeline.org/chat/" target="_blank">Chat confidencial</a>'
            ],
            received: "Gracias, vecino/a. Recibimos tu mensaje.",
            emergencyReply: "游뚿 <b>LLAME AL 911 DE INMEDIATO.</b>"
        }
    };

    // 2. CORE FUNCTIONS (Globally Scoped for onclick)
    window.toggleLanguage = function() {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        localStorage.setItem('alby_lang', currentLang);
        applyLanguage();
        checkHours();
    };

    window.toggleAccessibility = function() {
        document.body.classList.toggle('accessible-mode');
    };

    window.applyLanguage = function() {
        const t = translations[currentLang];
        document.getElementById('lang-toggle').innerText = t.langBtn;
        document.getElementById('sub-header').innerText = t.subHeader;
        document.getElementById('chat-title').innerText = t.chatTitle;
        document.getElementById('user-input').placeholder = t.placeholder;
        document.getElementById('send-btn').innerText = t.sendBtn;

        document.querySelectorAll('[data-text]').forEach(el => {
            const key = el.getAttribute('data-text');
            if (t[key]) el.innerText = t[key];
        });

        document.getElementById('calm-title').innerText = t.calmTitle;
        document.getElementById('calm-text').innerText = t.calmText;
        document.getElementById('calm-options').innerHTML =
            t.calmOptions.map(o => `<div class="calm-option">${o}</div>`).join('');
    };

    window.checkHours = function() {
        const now = new Date();
        const currentDay = now.getDay();
        const currentTime = now.toTimeString().slice(0,5);
        
        document.querySelectorAll('[data-hours]').forEach(card => {
            const statusEl = card.querySelector('[data-status]');
            const [days, times] = card.dataset.hours.split(',');
            const [startDay, endDay] = days.split('-').map(Number);
            const [startT, endT] = times.split('-');
            
            const isOpen = currentDay >= startDay && currentDay <= endDay &&
                currentTime >= startT && currentTime <= endT;
            statusEl.innerText = isOpen ? translations[currentLang].openNow : translations[currentLang].closedNow;
            statusEl.className = `status-badge ${isOpen ? 'open' : 'closed'}`;
        });
    };

    window.reportBrokenLink = function(btn, name) {
        btn.innerText = currentLang === 'es' ? "Reportando..." : "Reporting...";
        btn.disabled = true;
        setTimeout(() => {
            btn.style.display = 'none';
            const note = document.createElement('div');
            note.className = 'link-confirmation';
            note.innerText = currentLang === 'es' ? "Gracias, lo revisaremos." : "Thanks, we'll check it.";
            btn.parentNode.appendChild(note);
        }, 800);
    };

    // 3. INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
        applyLanguage();
        checkHours();

        document.getElementById('alby-form').onsubmit = (e) => {
            e.preventDefault();
            if (document.getElementById('honeypot').value) return; // Anti-bot

            const input = document.getElementById('user-input').value.toLowerCase();
            const reply = document.getElementById('reply-area');

            if (input.includes("911") || input.includes("emergency")) {
                reply.innerHTML = translations[currentLang].emergencyReply;
                const btn = document.querySelector('.emergency-btn');
                btn.classList.add('pulse-alert');
                setTimeout(() => btn.classList.remove('pulse-alert'), 3500);

            } else if (calmTriggers.some(t => input.includes(t))) {
                document.getElementById('calm-alby').style.display = 'block';
                reply.innerText = translations[currentLang].received;

            } else {
                reply.innerText = translations[currentLang].received;
            }

            reply.style.display = 'block';
            document.getElementById('user-input').value = "";
        };
    });

    // 4. CALM TRIGGERS (shared)
    const calmTriggers = [
        "overwhelmed", "not okay", "lost",
        "cant handle", "can't handle",
        "don't know what to do", "dont know what to do"
    ];
</script>
